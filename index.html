<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>iHentai ¬∑ Archive</title>
<meta name="theme-color" content="#0e1117">
<style>
:root{
  --bg:#0d0f12; --panel:#11141b; --card:#161b26; --text:#e8eef6; --muted:#a9b4c7;
  --bd:#222a3a; --accent:#7aa7ff; --accent2:#ffd36e;
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* top bar */
.topbar{position:sticky;top:0;z-index:30;background:var(--panel);border-bottom:1px solid var(--bd);padding:10px 12px;display:flex;align-items:center;gap:10px}
.iconbtn{width:36px;height:36px;border:1px solid var(--bd);border-radius:10px;background:#121724;display:grid;place-items:center;cursor:pointer}
.brand{font-weight:800;letter-spacing:.2px}
.brand i{font-style:normal;color:var(--accent)}
.top-actions{margin-left:auto;display:flex;gap:10px}

/* --- MENU POPOVER --- */
.menu-panel{
  position:fixed; top:58px; left:12px; z-index:40;
  background:var(--panel); border:1px solid var(--bd); border-radius:12px; padding:8px;
  width:220px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none;
}
.menu-panel.open{display:block}
.menu-item{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none;
}
.menu-item:hover{background:#0f1420}
.menu-caption{font-size:12px;color:var(--muted); margin-left:8px}
.menu-sep{height:1px;background:var(--bd);margin:6px 4px}

/* layout */
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.tools{display:flex;gap:10px;margin:10px 0 12px}
.tools input,.tools select{background:var(--card);border:1px solid var(--bd);color:var(--text);padding:10px;border-radius:12px;outline:none}
.tools input{flex:1}

.grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.grid{grid-template-columns:repeat(5,1fr)}}

.card{background:var(--card);border:1px solid var(--bd);border-radius:12px;overflow:hidden;cursor:pointer}
.thumb{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;background:#0a0d13;position:relative}
.thumb::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%);animation:sh 1.1s infinite}
.thumb.ready::after{display:none}
@keyframes sh{100%{transform:translateX(100%)}}
.body{padding:10px}
.body h3{margin:0;font-size:14px;line-height:1.3}
.badge{display:inline-block;margin-top:6px;font-size:11px;border-radius:999px;padding:3px 6px;background:var(--accent2);color:#0d0f12}

/* viewer */
.viewer{position:fixed;inset:0;background:#07080bcc;backdrop-filter:blur(4px);display:none;z-index:40}
.viewer.open{display:block}
.page{position:absolute;inset:8px;inset-block-end:12px;background:var(--panel);border:1px solid var(--bd);border-radius:14px;display:grid;grid-template-rows:auto 1fr;overflow:hidden}
.page header{padding:10px 12px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px}
.page .title{font-weight:800}
.page .pill{margin-left:auto;color:var(--muted);font-size:12px}
.page .main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;overflow:auto}
@media(min-width:920px){.page .main{grid-template-columns:2fr 1fr}}
.player{width:100%;aspect-ratio:16/9;background:#000;border:1px solid var(--bd);border-radius:12px}
.side{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;height:max-content}
.btn{border:1px solid var(--bd);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
.btn.primary{background:var(--accent);border-color:#3a5fa8;color:#061225}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="iconbtn" id="menuBtn" aria-haspopup="true" aria-expanded="false" aria-controls="menuPanel">‚ò∞</div>
    <div class="brand"><i>i</i>Hentai ¬∑ <span style="opacity:.9">Archive</span></div>
    <div class="top-actions">
      <div class="iconbtn" id="refreshBtn">‚ü≥</div>
      <div class="iconbtn" id="themeBtn">‚òæ</div>
    </div>
  </div>

  <!-- POPOVER MENU -->
  <nav id="menuPanel" class="menu-panel" role="menu" aria-label="Main menu">
    <a class="menu-item" href="./" role="menuitem">üè† Trang Ch·ªß</a>
    <div class="menu-sep"></div>
    <a class="menu-item" href="https://zerdata.github.io/zerdata1" role="menuitem" target="_self">üìö Gallary ¬∑ Th∆∞ Vi·ªán</a>
    <div class="menu-caption">M·ªü trang th∆∞ vi·ªán ph·ª•</div>
  </nav>

  <div class="wrap">
    <div class="tools">
      <input id="q" placeholder="T√¨m theo t√™n‚Ä¶">
      <select id="sort">
        <option value="new">M·ªõi nh·∫•t</option>
        <option value="az">A ‚Üí Z</option>
        <option value="za">Z ‚Üí A</option>
      </select>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <!-- Viewer -->
  <div id="viewer" class="viewer">
    <div class="page">
      <header>
        <div class="title" id="v-title"></div>
        <div class="pill">Ngu·ªìn: Archive.org</div>
        <button class="btn" id="closeBtn">ƒê√≥ng</button>
      </header>
      <div class="main">
        <div>
          <iframe id="iframe" class="player" frameborder="0" allowfullscreen referrerpolicy="no-referrer"></iframe>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <a id="openArchive" class="btn primary" target="_blank" rel="noopener">M·ªü tr√™n Archive</a>
            <button id="copyLink" class="btn">Copy link nh√∫ng</button>
          </div>
        </div>
        <aside class="side">
          <div class="small">B√¨a</div>
          <img id="v-cover" class="thumb" style="width:100%;aspect-ratio:3/4;border-radius:10px;border:1px solid var(--bd);margin-top:6px"/>
        </aside>
      </div>
    </div>
  </div>

<script>
/* ===== refs ===== */
const grid = document.getElementById("grid");
const qEl   = document.getElementById("q");
const sortEl= document.getElementById("sort");
const refreshBtn = document.getElementById("refreshBtn");
const viewer= document.getElementById("viewer");
const vTitle= document.getElementById("v-title");
const vCover= document.getElementById("v-cover");
const iframe= document.getElementById("iframe");
const openArchive = document.getElementById("openArchive");
const copyLink = document.getElementById("copyLink");

/* menu refs */
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');

let items=[], filtered=[], lazyObs;

/* ===== utils ===== */
function slugify(s){
  return String(s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
}

/* cover candidates */
function coverCandidates(name, archiveId){
  const sName = slugify(name||"");
  const sId = slugify(archiveId||"");
  const exts = ["jpg","jpeg","png","webp","gif","avif"];
  const bases = Array.from(new Set([sName, sId])).filter(Boolean);
  const list=[];
  for(const b of bases){ for(const e of exts){ list.push(`BG/${b}.bg.${e}`); } }
  for(const b of bases){ for(const e of exts){ list.push(`BG/${b}.${e}`); } }
  return list;
}

/* set image source with fallbacks */
function setSmartSrc(img, candidates){
  const tryNext = ()=>{
    const u = candidates.shift();
    if(!u){ img.classList.add('ready'); return; }
    img.src = u;
  };
  img.onerror = tryNext;
  img.onload  = ()=>img.classList.add('ready');
  tryNext();
}

/* ===== data ===== */
async function loadManifest(){
  const res = await fetch("zerdata_make_manifest.json?"+Date.now());
  if(!res.ok) return [];
  const rows = await res.json();
  const out=[];
  for(const r of rows){
    const m = String(r.link).match(/archive\.org\/(?:details|embed)\/([^\/?#]+)/i);
    if(!m) continue;
    const archiveId = m[1];
    out.push({
      id: slugify(r.name || archiveId),
      title: r.name || archiveId,
      archiveId,
      embed: `https://archive.org/embed/${archiveId}`,
      page:  `https://archive.org/details/${archiveId}`,
      _ts: Date.now(),
      covers: coverCandidates(r.name, archiveId)
    });
  }
  return out;
}

/* ===== render ===== */
function render(){
  grid.innerHTML="";
  const q = qEl.value.trim().toLowerCase();
  filtered = items.filter(x=>!q || x.title.toLowerCase().includes(q));

  if(sortEl.value==="az") filtered.sort((a,b)=>a.title.localeCompare(b.title));
  else if(sortEl.value==="za") filtered.sort((a,b)=>b.title.localeCompare(a.title));
  else filtered.sort((a,b)=>(b._ts||0)-(a._ts||0));

  filtered.forEach((it,idx)=>{
    const card = document.createElement("div"); card.className="card"; card.onclick=()=>openViewer(it.id);
    const img = document.createElement("img");
    img.className="thumb";
    img.alt = it.title;
    if(idx < 16){ setSmartSrc(img, [...it.covers]); }
    else{ img.dataset.covers = JSON.stringify(it.covers); img.loading = "lazy"; }
    card.appendChild(img);

    const body = document.createElement("div"); body.className="body";
    const h3 = document.createElement("h3"); h3.textContent = it.title; body.appendChild(h3);
    const b = document.createElement("span"); b.className="badge"; b.textContent="Archive"; body.appendChild(b);
    card.appendChild(body);
    grid.appendChild(card);
  });

  setupLazy();
}
function setupLazy(){
  if(lazyObs) lazyObs.disconnect();
  lazyObs = new IntersectionObserver((ents,obs)=>{
    ents.forEach(e=>{
      if(e.isIntersecting){
        const img = e.target;
        if(!img.src){
          const cands = JSON.parse(img.dataset.covers||"[]");
          setSmartSrc(img, cands);
        }
        obs.unobserve(img);
      }
    });
  }, {root:null, rootMargin:"250px 0px", threshold:0.01});

  grid.querySelectorAll("img.thumb").forEach((img,idx)=>{
    if(!img.src && idx >= 16) lazyObs.observe(img);
  });
}

/* ===== viewer ===== */
function getItem(id){ return items.find(x=>x.id===id); }
function openViewer(id){
  const it = getItem(id); if(!it) return;
  vTitle.textContent = it.title;
  vCover.classList.remove('ready');
  setSmartSrc(vCover, [...it.covers]);
  iframe.src = it.embed;
  openArchive.href = it.page;
  viewer.classList.add("open");
}
document.getElementById("closeBtn").onclick = ()=>{ viewer.classList.remove("open"); iframe.src=""; };
copyLink.onclick = async ()=>{ try{ await navigator.clipboard.writeText(iframe.src); copyLink.textContent="ƒê√£ copy"; setTimeout(()=>copyLink.textContent="Copy link nh√∫ng",1200);}catch(e){ alert(iframe.src); } };

qEl.oninput = render; sortEl.onchange = render;
refreshBtn.onclick = async ()=>{ items = await loadManifest(); items.forEach((it,i)=>it._ts = Date.now()+i); render(); };

/* ===== menu logic ===== */
function closeMenu(){ menuPanel.classList.remove('open'); menuBtn.setAttribute('aria-expanded','false'); }
function toggleMenu(e){
  e?.stopPropagation();
  const open = menuPanel.classList.toggle('open');
  menuBtn.setAttribute('aria-expanded', open?'true':'false');
}
menuBtn.addEventListener('click', toggleMenu);
document.addEventListener('click', (e)=>{
  if(!menuPanel.classList.contains('open')) return;
  const within = menuPanel.contains(e.target) || menuBtn.contains(e.target);
  if(!within) closeMenu();
});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

/* ===== init ===== */
(async function(){
  items = await loadManifest();
  items.forEach((it,i)=>it._ts = Date.now()+i);
  render();
})();
</script>
</body>
</html>