<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>XGallery · Archive (simple)</title>
<style>
  :root{--bg:#0d0f12;--card:#161b26;--text:#e9eef6;--muted:#a8b4c7;--bd:#222a3a;--accent:#7aa7ff}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#11141b;border-bottom:1px solid var(--bd);padding:10px 14px;font-weight:700}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .tools{display:flex;gap:8px;margin:8px 0 12px}
  .tools input,.tools select{background:var(--card);border:1px solid var(--bd);color:var(--text);padding:10px;border-radius:10px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(5,1fr)}}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;overflow:hidden;cursor:pointer}
  .thumb{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;background:#0a0d13;position:relative}
  .thumb::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%);animation:sh 1.2s infinite}
  .thumb.loaded::after{display:none}
  @keyframes sh{100%{transform:translateX(100%)}}
  .body{padding:10px} .body h3{margin:0;font-size:14px;line-height:1.3}
  .badge{display:inline-block;margin-top:6px;padding:3px 6px;font-size:11px;border-radius:999px;background:#ffd36e;color:#0d0f12}

  /* viewer */
  #viewer{position:fixed;inset:0;background:#000a;backdrop-filter:blur(4px);display:none}
  #viewer.open{display:flex;flex-direction:column}
  #vhead{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#11141b;border-bottom:1px solid var(--bd)}
  #vtitle{font-weight:700} .pill{margin-left:auto;color:var(--muted);font-size:12px}
  #vmain{flex:1;display:grid;gap:12px;padding:12px;grid-template-columns:1fr}
  @media(min-width:920px){#vmain{grid-template-columns:2fr 1fr}}
  .player{width:100%;aspect-ratio:16/9;background:#000;border:1px solid var(--bd);border-radius:12px}
  .side{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:12px;height:max-content}
  .btn{border:1px solid var(--bd);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#3a5fa8;color:#061225}
</style>
</head>
<body>
<header>XGallery · Archive</header>

<div class="wrap">
  <div class="tools">
    <input id="q" placeholder="Tìm theo tên…">
    <select id="sort">
      <option value="new">Mới nhất</option>
      <option value="az">A → Z</option>
      <option value="za">Z → A</option>
    </select>
  </div>
  <div id="grid" class="grid"></div>
</div>

<!-- Viewer -->
<div id="viewer">
  <div id="vhead">
    <div id="vtitle"></div>
    <div class="pill">Nguồn: Archive</div>
    <button id="closeBtn" class="btn">Đóng</button>
  </div>
  <div id="vmain">
    <div>
      <iframe id="iframe" class="player" frameborder="0" allowfullscreen referrerpolicy="no-referrer"></iframe>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <a id="openArchive" class="btn primary" target="_blank" rel="noopener">Mở trên Archive</a>
        <button id="copyLink" class="btn">Copy link nhúng</button>
      </div>
    </div>
    <div class="side">
      <div style="font-size:12px;color:var(--muted)">Bìa</div>
      <img id="vcover" class="thumb" style="width:100%;aspect-ratio:3/4;border-radius:10px;border:1px solid var(--bd);margin-top:6px">
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = s=>document.querySelector(s);
const grid = $("#grid"), qEl=$("#q"), sortEl=$("#sort");
const viewer=$("#viewer"), vtitle=$("#vtitle"), vcover=$("#vcover");
const iframe=$("#iframe"), openArchive=$("#openArchive"), copyLink=$("#copyLink");
let items=[], filtered=[], lazyObs;

/* slug: như cũ */
function slugify(s){
  return String(s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
}
async function headOK(url){ try{ const r=await fetch(url,{method:"HEAD"}); return r.ok; }catch{return false;} }

/* lấy bìa THEO MẪU CŨ:
   1) BG/<slug(name)>.bg.(jpg|jpeg|png|webp)
   2) nếu không có, thử BG/<slug(archiveId)>.bg.(...)
*/
async function resolveCover(name, archiveId){
  const exts = ["jpg","jpeg","png","webp"];
  const sName = slugify(name||"");
  const sId   = slugify(archiveId||"");
  for(const u of exts.map(e=>`BG/${sName}.bg.${e}`)){ if(await headOK(u)) return u; }
  for(const u of exts.map(e=>`BG/${sId}.bg.${e}`)){ if(await headOK(u)) return u; }
  return ""; // không có bìa cũng ok
}

/* ===== data ===== */
async function loadManifest(){
  const res = await fetch("zerdata_make_manifest.json?"+Date.now());
  if(!res.ok) return [];
  const rows = await res.json();
  const out=[];
  for(const r of rows){
    const m = String(r.link).match(/archive\.org\/(?:details|embed)\/([^\/?#]+)/i);
    if(!m) continue;
    const archiveId = m[1];
    const id = slugify(r.name||archiveId);
    const cover = await resolveCover(r.name, archiveId);
    out.push({
      id, title:r.name||archiveId, cover,
      embed:`https://archive.org/embed/${archiveId}`,
      page:`https://archive.org/details/${archiveId}`,
      _ts: Date.now()
    });
  }
  return out;
}

/* ===== render grid (lazy) ===== */
function render(){
  grid.innerHTML="";
  const q = qEl.value.trim().toLowerCase();
  filtered = items.filter(x=>!q || x.title.toLowerCase().includes(q));
  if(sortEl.value==="az") filtered.sort((a,b)=>a.title.localeCompare(b.title));
  else if(sortEl.value==="za") filtered.sort((a,b)=>b.title.localeCompare(a.title));
  else filtered.sort((a,b)=>(b._ts||0)-(a._ts||0));

  for(const it of filtered){
    const card = document.createElement("div"); card.className="card"; card.onclick=()=>openViewer(it.id);
    const img = document.createElement("img");
    img.className="thumb"; img.alt=it.title; img.loading="lazy"; img.decoding="async";
    img.dataset.src = it.cover || "https://picsum.photos/400/560?blur=3";
    card.appendChild(img);
    const body = document.createElement("div"); body.className="body";
    const h3 = document.createElement("h3"); h3.textContent = it.title; body.appendChild(h3);
    const b = document.createElement("span"); b.className="badge"; b.textContent="Archive"; body.appendChild(b);
    card.appendChild(body);
    grid.appendChild(card);
  }
  setupLazy();
}
function setupLazy(){
  if(lazyObs) lazyObs.disconnect();
  lazyObs = new IntersectionObserver((ents,obs)=>{
    ents.forEach(e=>{
      if(e.isIntersecting){
        const img = e.target; if(!img.src){ img.src = img.dataset.src; img.onload=()=>img.classList.add('loaded'); img.onerror=()=>img.classList.add('loaded'); }
        obs.unobserve(img);
      }
    });
  }, {root:null,rootMargin:"200px 0px",threshold:0.01});
  const all = Array.from(grid.querySelectorAll('img.thumb'));
  all.forEach((img,i)=>{ if(i<8){ img.src=img.dataset.src; img.onload=()=>img.classList.add('loaded'); } else lazyObs.observe(img); });
}

/* ===== viewer ===== */
function getItem(id){ return items.find(x=>x.id===id); }
function openViewer(id){
  const it = getItem(id); if(!it) return;
  vtitle.textContent = it.title;
  vcover.src = it.cover || "";
  vcover.classList.add('loaded');
  iframe.src = it.embed; openArchive.href = it.page;
  viewer.classList.add("open");
}
document.getElementById("closeBtn").onclick = ()=>{ viewer.classList.remove("open"); iframe.src=""; };
copyLink.onclick = async ()=>{ try{ await navigator.clipboard.writeText(iframe.src); copyLink.textContent="Đã copy"; setTimeout(()=>copyLink.textContent="Copy link nhúng",1200);}catch(e){ alert(iframe.src); } };

qEl.oninput = render; sortEl.onchange = render;

/* ===== init ===== */
(async function(){
  items = await loadManifest();
  items.forEach((it,i)=>it._ts = Date.now()+i);
  render();
})();
</script>
</body>
</html>
