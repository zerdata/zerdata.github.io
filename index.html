<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>XGallery – Video/Ảnh</title>
  <style>
    :root {
      --bg:#0f1115; --card:#151922; --text:#e8edf2; --muted:#a8b3c7;
      --border:#20283a; --accent:#4ea1ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:sans-serif}
    header{position:sticky;top:0;background:#10131b;border-bottom:1px solid var(--border);z-index:10;padding:10px;text-align:center}
    main{display:flex}
    aside{width:220px;padding:10px;border-right:1px solid var(--border)}
    section{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:6px;overflow:hidden;cursor:pointer}
    .card img{width:100%;height:160px;object-fit:cover;display:block}
    .card h3{margin:8px;font-size:14px}
    .badge{display:inline-block;padding:2px 6px;font-size:11px;margin:2px;border-radius:3px;background:var(--accent);color:#fff}
    #viewer{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;flex-direction:column;z-index:1000}
    #viewerMain{flex:1;display:flex;align-items:center;justify-content:center}
    #viewer footer{padding:10px;background:#111;border-top:1px solid var(--border);text-align:center}
    video,iframe{max-width:100%;max-height:100%}
    button.btn{margin:0 4px;padding:6px 10px;cursor:pointer}
  </style>
</head>
<body>
  <header><h1>XGallery</h1></header>
  <main>
    <aside>
      <h4>Bộ lọc</h4>
      <label><input type="checkbox" class="f-type" value="video" checked> Video</label><br/>
      <label><input type="checkbox" class="f-type" value="images" checked> Ảnh</label><br/>
      <label><input type="checkbox" class="f-src" value="pomf2" checked> Nguồn: Pomf2</label><br/>
      <label><input type="checkbox" class="f-src" value="jwplayer" checked> Nguồn: JW Player</label><br/>
      <label><input type="checkbox" class="f-src" value="archive" checked> Nguồn: Archive</label>
    </aside>
    <section id="grid"></section>
  </main>

  <!-- Viewer -->
  <div id="viewer">
    <div id="viewerMain">
      <div id="jwplayerDiv" style="display:none;aspect-ratio:16/9"></div>
      <video id="html5Video" controls preload="metadata"></video>
      <iframe id="archiveFrame" style="display:none;width:100%;aspect-ratio:16/9" frameborder="0" allowfullscreen></iframe>
    </div>
    <footer>
      <div id="sourceSwitch"></div>
      <button onclick="closeViewer()" class="btn">Đóng</button>
    </footer>
  </div>

<script>
const grid = document.getElementById("grid");
const viewer = document.getElementById("viewer");
const html5Video = document.getElementById("html5Video");
const jwDiv = document.getElementById("jwplayerDiv");
const archiveFrame = document.getElementById("archiveFrame");
const sourceSwitch = document.getElementById("sourceSwitch");

let items = [], currentId=null;

function slug(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");}

async function resolveCoverByBG(id){
  const exts=["jpg","jpeg","png","webp"];
  for(const e of exts){
    const url=`BG/${id}.bg.${e}`;
    try{let r=await fetch(url,{method:"HEAD"});if(r.ok) return url;}catch{}
  }
  return "";
}

async function loadManifest(){
  const res = await fetch("zerdata_make_manifest.json?"+Date.now());
  if(!res.ok) return [];
  const rows = await res.json();
  const out=[];
  for(const row of rows){
    const id = slug(row.name);
    const cover = await resolveCoverByBG(id);
    const sources={};
    if (/archive\.org\//i.test(row.link)){
      let m=row.link.match(/archive\.org\/(?:details|embed)\/([^/?#]+)/i);
      const arcId=m?m[1]:null;
      sources.archive={id:arcId,embed:arcId?`https://archive.org/embed/${arcId}`:row.link};
    } else if (/pomf2\.lain\.la\//i.test(row.link)){
      sources.pomf2=[row.link];
    } else {
      sources.jwplayer={file:row.link};
    }
    out.push({id,title:row.name,cover,type:"video",sources});
  }
  return out;
}

function render(){
  grid.innerHTML="";
  for(const it of items){
    const card=document.createElement("div");
    card.className="card"; card.onclick=()=>openViewer(it.id);
    if(it.cover){let img=document.createElement("img");img.src=it.cover;card.appendChild(img);}
    let h3=document.createElement("h3");h3.textContent=it.title;card.appendChild(h3);
    if(it.sources.pomf2) card.appendChild(b("Pomf2"));
    if(it.sources.jwplayer) card.appendChild(b("JW"));
    if(it.sources.archive) card.appendChild(b("Archive"));
    grid.appendChild(card);
  }
}
function b(t){let s=document.createElement("span");s.className="badge";s.textContent=t;return s;}

function closeViewer(){
  viewer.style.display="none"; 
  html5Video.pause(); html5Video.src=""; 
  archiveFrame.src=""; 
  if(window.jwplayer){try{jwplayer(jwDiv).remove();}catch{}}
}

function openViewer(id){
  currentId=id;
  const it=items.find(x=>x.id===id); if(!it) return;
  viewer.style.display="flex";
  let prefer=it.sources.pomf2?"pomf2":(it.sources.jwplayer?"jwplayer":"archive");
  switchSource(prefer);
  sourceSwitch.innerHTML="";
  if(it.sources.pomf2){let b=document.createElement("button");b.className="btn";b.textContent="Nguồn: Pomf2";b.onclick=()=>switchSource("pomf2");sourceSwitch.appendChild(b);}
  if(it.sources.jwplayer){let b=document.createElement("button");b.className="btn";b.textContent="Nguồn: JW Player";b.onclick=()=>switchSource("jwplayer");sourceSwitch.appendChild(b);}
  if(it.sources.archive){let b=document.createElement("button");b.className="btn";b.textContent="Nguồn: Archive";b.onclick=()=>switchSource("archive");sourceSwitch.appendChild(b);}
}

async function switchSource(src){
  const it=items.find(x=>x.id===currentId); if(!it) return;
  html5Video.style.display="none"; jwDiv.style.display="none"; archiveFrame.style.display="none";
  html5Video.pause(); html5Video.src=""; archiveFrame.src="";
  if(src==="pomf2"){
    let raw=it.sources.pomf2[0];
    let url=`https://mp4-proxy.tuvo9905.workers.dev/?u=${encodeURIComponent(raw)}`;
    html5Video.style.display="block"; html5Video.src=url; html5Video.load();
  } else if(src==="jwplayer"){
    let f=it.sources.jwplayer.file;
    html5Video.style.display="block"; html5Video.src=f; html5Video.load();
  } else if(src==="archive"){
    let emb=it.sources.archive.embed;
    archiveFrame.style.display="block"; archiveFrame.src=emb;
  }
}

loadManifest().then(r=>{items=r;render();});
</script>
</body>
</html>
